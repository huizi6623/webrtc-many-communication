!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.JDLoader_Ext={})}(this,function(e){"use strict";void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:0<e?1:+e}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),t=1;t<arguments.length;t++){var r=arguments[t];if(null!=r)for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n[s]=r[s])}return n});var r=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},n=function(){function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}}(),o=function(){function e(){r(this,e)}return n(e,[{key:"load",value:function(e,t,r,s){if(void 0===e)throw new Error('"url" is required!');var n=void 0;(n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).addEventListener("load",function(e){var n=this.response;200===this.status||0===this.status?(0===this.status&&console.warn("FileLoader: HTTP Status 0 received."),t&&t(n),s&&s({success:!0})):(r&&r(e),s&&s({success:!1}))},!1),n.addEventListener("error",function(e){r&&r(e),s&&s({success:!1})},!1),n.open("GET",e,!0),n.send()}}]),e}(),a={gettype:Object.prototype.toString,isObject:function(e){return"[object Object]"==this.gettype.call(e)},isArray:function(e){return"[object Array]"==this.gettype.call(e)},isString:function(e){return"[object String]"==this.gettype.call(e)},isBoolean:function(e){return"[object Boolean]"==this.gettype.call(e)},isFunction:function(e){return"[object Function]"==this.gettype.call(e)},isNumber:function(e){return"[object Number]"==this.gettype.call(e)},isUndefined:function(e){return"[object Undefined]"==this.gettype.call(e)},isNULL:function(e){return"[object Null]"==this.gettype.call(e)},extractUrlBase:function(e){var n=e.lastIndexOf("/");return-1===n?"./":e.substr(0,n+1)},Queue:function(){var n=[];this.enqueue=function(e){n.push(e)},this.dequeue=function(){return n.shift()},this.front=function(){return n[0]},this.isEmpty=function(){return 0==n.length},this.clear=function(){n=[]},this.size=function(){return n.length},this.print=function(){console.log(n)}}},t=function(){function e(){r(this,e)}return n(e,[{key:"load",value:function(e,n,t,r){var s=this,i=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:a.extractUrlBase(e);(new o).load(e,function(e){s.parse(e,n,i)},t,r)}},{key:"parse",value:function(e,n,t){var r=e;a.isObject(e)||(r=JSON.parse(e)),n&&n(this.parseData(r,t))}},{key:"setTexturePath",value:function(e){this.texturePath=e}},{key:"parseData",value:function(z,h){function K(e){if(e&&e.skin&&e.skin.skinBones.length&&e.skin.skinWeights.length)return X;var n=[];n.push(X[0]);var t=X[e.node],r={};return r.name=t.name,r.parent=0,r.pos=[t.pos[0],t.pos[1],t.pos[2]],r.scl=[t.scl[0],t.scl[1],t.scl[2]],r.rotq=[t.rotq[0],t.rotq[1],t.rotq[2],t.rotq[3]],n.push(r),n}function Q(e){var n=new THREE.Matrix4;if(!X||e<0||!X[e])return n;for(var t=e;0<=t;t=X[t].parent){var r=X[t],s=new THREE.Vector3(r.pos[0],r.pos[1],r.pos[2]),i=new THREE.Vector3(r.scl[0],r.scl[1],r.scl[2]),o=new THREE.Quaternion(r.rotq[0],r.rotq[1],r.rotq[2],r.rotq[3]),a=(new THREE.Matrix4).compose(s,o,i);n.premultiply(a)}return n}function U(e){var n=-1;if(!e||!z.materials)return 0;for(var t=0;t<e.length;++t){var r=z.materials[e[t].materialIndex];if(r&&r.maps)for(var s=0;s<r.maps.length;++s)if("diffuse"==r.maps[s].type)if(n<0)n=r.maps[s].uvsIndex;else if(n!=r.maps[s].uvsIndex)return n}return n<0?0:n}function a(e,n){if(!e)return console.error("parseOffsetAnimation: no animation"),null;var t=e.fps||30,r=!0,s=e.length||-1;"frames"==e.timeline&&(r=!1,s/=t);var i=[],o=e.name||"default",a=(e.animNodes||[])[n];if(!a)return console.error("parseOffsetAnimation: animNode "+n+" is null !"),null;var l="";void 0!==a.nodeName?l=a.nodeName:void 0!==a.nodeIndex&&(l=X[a.nodeIndex].name);var u=function(e,n){for(var t={times:[],values:[]},r={times:[],values:[]},s={times:[],values:[]},i=[],o=n;0<=o;o=X[o].parent){var a=e.animNodes[o];i=m(i=m(i=m(i,a.scl.times),a.rot.times),a.pos.times)}t.times=t.times.concat(i),r.times=r.times.concat(i),s.times=s.times.concat(i);var l=new THREE.Vector3,u=new THREE.Vector3,c=new THREE.Quaternion,p=new THREE.Matrix4,f=new THREE.Matrix4;f.getInverse(Q(n));for(var h=0;h<i.length;++h)(p=d(e,n,i[h])).multiply(f),p.decompose(l,c,u),t.values.push(u.x),t.values.push(u.y),t.values.push(u.z),s.values.push(l.x),s.values.push(l.y),s.values.push(l.z),r.values.push(c.x),r.values.push(c.y),r.values.push(c.z),r.values.push(c.w);return{sclTrackObject:t,posTrackObject:s,rotTrackObject:r}}(e,n),c=u.sclTrackObject,p=u.posTrackObject,f=u.rotTrackObject;return v(r,t,THREE.VectorKeyframeTrack,l+".position",p,i),v(r,t,THREE.VectorKeyframeTrack,l+".scale",c,i),v(r,t,THREE.QuaternionKeyframeTrack,l+".quaternion",f,i),0===i.length?(console.error("parseOffsetAnimation: tracks.length is 0 !"),null):new THREE.AnimationClip(o,s,i)}function d(e,n,t){var r=new THREE.Matrix4;if(!X||n<0||!e.animNodes[n])return r;for(var s,i,o,a,l,u,c,p,f,h,d=n;0<=d;d=X[d].parent){var m=e.animNodes[d];l=(i=(s=E(m.scl.times,t)).iBegin)==(o=s.iEnd)?new THREE.Vector3(m.scl.values[3*i],m.scl.values[3*i+1],m.scl.values[3*i+2]):(h=(t-m.scl.times[i])/(m.scl.times[o]-m.scl.times[i]),l=new THREE.Vector3(m.scl.values[3*i],m.scl.values[3*i+1],m.scl.values[3*i+2]),p=new THREE.Vector3(m.scl.values[3*o],m.scl.values[3*o+1],m.scl.values[3*o+2]),l.lerp(p,h)),a=(i=(s=E(m.pos.times,t)).iBegin)==(o=s.iEnd)?new THREE.Vector3(m.pos.values[3*i],m.pos.values[3*i+1],m.pos.values[3*i+2]):(h=(t-m.pos.times[i])/(m.pos.times[o]-m.pos.times[i]),a=new THREE.Vector3(m.pos.values[3*i],m.pos.values[3*i+1],m.pos.values[3*i+2]),c=new THREE.Vector3(m.pos.values[3*o],m.pos.values[3*o+1],m.pos.values[3*o+2]),a.lerp(c,h)),u=(i=(s=E(m.rot.times,t)).iBegin)==(o=s.iEnd)?new THREE.Quaternion(m.rot.values[4*i],m.rot.values[4*i+1],m.rot.values[4*i+2],m.rot.values[4*i+3]):(h=(t-m.rot.times[i])/(m.rot.times[o]-m.rot.times[i]),u=new THREE.Quaternion(m.rot.values[4*i],m.rot.values[4*i+1],m.rot.values[4*i+2],m.rot.values[4*i+3]),f=new THREE.Quaternion(m.rot.values[4*o],m.rot.values[4*o+1],m.rot.values[4*o+2],m.rot.values[4*o+3]),u.slerp(f,h));var v=(new THREE.Matrix4).compose(a,u,l);r.premultiply(v)}return r}function E(e,n){for(var t=0,r=0,s=0;s<e.length;++s){if(e[s]==n){t=r=s;break}if(e[s]>n){t=r=s;break}if(s==e.length-1){t=r=s;break}if(n<e[s+1]){r=(t=s)+1;break}}return{iBegin:t,iEnd:r}}function m(e,n){for(var t=[],r=0,s=0;r<e.length&&s<n.length;)e[r]<n[s]?(0!=t.length&&e[r]==t[t.length-1]||t.push(e[r]),++r):(e[r]>n[s]?0!=t.length&&n[s]==t[t.length-1]||t.push(n[s]):(0!=t.length&&t[t.length-1]==e[r]||t.push(e[r]),++r),++s);for(;r<e.length;)0!=t.length&&e[r]==t[t.length-1]||t.push(e[r]),++r;for(;s<n.length;)0!=t.length&&n[s]==t[t.length-1]||t.push(n[s]),++s;return t}function l(e){if(!e)return console.error("parseKeyFrameAnimation: no animation"),null;var n=e.fps||30,t=!0,r=e.length||-1;"frames"==e.timeline&&(t=!1,r/=n);for(var s=[],i=e.name||"default",o=e.animNodes||[],a=0;a<o.length;a++){var l=o[a];if(l){var u="";void 0!==l.nodeName?u=l.nodeName:void 0!==l.nodeIndex&&(u=X[l.nodeIndex].name);var c=u;v(t,n,THREE.VectorKeyframeTrack,c+".position",l.pos,s),v(t,n,THREE.VectorKeyframeTrack,c+".scale",l.scl,s),v(t,n,THREE.QuaternionKeyframeTrack,c+".quaternion",l.rot,s)}}return 0===s.length?null:new THREE.AnimationClip(i,r,s)}function v(e,n,t,r,s,i){if(s&&Array.isArray(s.times)&&Array.isArray(s.values)){var o=[],a=[];if(o=o.concat(s.times),a=a.concat(s.values),!e)for(var l=0;l<o.length;++l)o[l]/=n;o&&0!=o.length&&a&&0!=a.length&&i.push(new t(r,o,a))}}var e=0,g=this,y=[],X=[],_=[],G=[],J=[],D=[],n=[];for(function(){if(y=[],void 0!==z.materials&&0!==z.materials.length){var e,n,t,r,s,i,o,a,l,u=0;for(u=0;u<z.materials.length;++u){var c=z.materials[u];if(n=new THREE.Color(16777215),t=new THREE.Color(1644825),c.diffuse&&n.fromArray(c.diffuse),c.specular&&t.fromArray(c.specular),r=void 0!==c.glossiness?c.glossiness:40,l=a=o=i=s=void 0,c.maps)for(var p=0;p<c.maps.length;++p)if(""!=c.maps[p].file)if("diffuse"==c.maps[p].type)(f=new THREE.TextureLoader).setCrossOrigin(g.crossOrigin),(s=f.load(h+c.maps[p].file)).wrapS=s.wrapT=THREE.RepeatWrapping;else if("specular"==c.maps[p].type)(f=new THREE.TextureLoader).setCrossOrigin(g.crossOrigin),(i=f.load(h+c.maps[p].file)).wrapS=i.wrapT=THREE.RepeatWrapping;else if("bump"==c.maps[p].type)(f=new THREE.TextureLoader).setCrossOrigin(g.crossOrigin),(o=f.load(h+c.maps[p].file)).wrapS=o.wrapT=THREE.RepeatWrapping;else if("normal"==c.maps[p].type)(f=new THREE.TextureLoader).setCrossOrigin(g.crossOrigin),(a=f.load(h+c.maps[p].file)).wrapS=a.wrapT=THREE.RepeatWrapping;else if("opacity"==c.maps[p].type){var f=new THREE.TextureLoader;f.setCrossOrigin(g.crossOrigin),(l=f.load(h+c.maps[p].file)).wrapS=l.wrapT=THREE.RepeatWrapping}e=new THREE.MeshPhongMaterial({name:name,color:n.getHex(),specular:t.getHex(),shininess:r,skinning:!0}),s&&(e.map=s),i&&(e.specularMap=i),o&&(e.bumpMap=o),a&&(e.normalMap=a),l&&(e.alphaMap=l,e.transparent=!0),void 0!==c.opacity&&(e.opacity=c.opacity,c.opacity<1&&(e.transparent=!0)),y.push(e)}}}(),function(){if(X=void 0!==z.hierarchy?z.hierarchy.nodes:z.nodes,Array.isArray(X)&&0<X.length)for(var e=0;e<X.length;++e)void 0!==X[e].rot&&(X[e].rotq=X[e].rot,X[e].rot=void 0);else X=[]}(),function(){var e=z.model;if(e){var n,t,r,s,i,o,a,l,u,c,p,f,h,d,m,v,E,g,y,T,w,b,R,H,k,x,A,S,O;if(e.splineShapes)for(H=0;H<e.splineShapes.length&&null!=(k=e.splineShapes[H]);++H)for(R=Q(y=k.node),A=0;A<k.splines.length;++A){for((i=new THREE.BufferGeometry).name=k.name,1<k.splines.length&&(i.name+="_SubSpline"+A),O=new THREE.CurvePath,S=k.splines[A],n=0;n+2<S.points.length;n+=3)(f=new THREE.Vector3(S.points[n],S.points[n+1],S.points[n+2])).applyMatrix4(R),S.points[n]=f.x,S.points[n+1]=f.y,S.points[n+2]=f.z;for(n=0;n+11<S.points.length;n+=9)x=new THREE.CubicBezierCurve3(new THREE.Vector3(S.points[n],S.points[n+1],S.points[n+2]),new THREE.Vector3(S.points[n+3],S.points[n+4],S.points[n+5]),new THREE.Vector3(S.points[n+6],S.points[n+7],S.points[n+8]),new THREE.Vector3(S.points[n+9],S.points[n+10],S.points[n+11])),O.add(x);i.setFromPoints(O.getPoints(k.steps+1)),_.push(i),J.push("Line"),D.push(k),G.push(y)}if(e.meshes)for(var L=0;L<e.meshes.length;++L){if(i=new THREE.BufferGeometry,null==(a=e.meshes[L]))return;if(a.name&&(i.name=a.name),null==(u=a.verts))return;if(null==(p=a.vertElement))return;if(d=a.face,m=p.vertIndices,v=p.normals,p.colors,E=p.uvs,g=a.skin,null==(y=a.node)||!(0<=y&&y<X.length))return;if(!((T=X[y])&&T.pos&&T.rotq&&T.scl))return;if(null==d)return;if(w=d.vertElementIndices,b=d.groups,!w||!b)return;R=Q(y),l=m.length;var j=new Float32Array(3*l);for(c=0;c<l;++c)n=3*m[c],t=3*c,(f=new THREE.Vector3(u[n],u[n+1],u[n+2])).applyMatrix4(R),j[t]=f.x,j[t+1]=f.y,j[t+2]=f.z;if(i.addAttribute("position",new THREE.BufferAttribute(j,3)),void 0!==v&&0<v.length){var B=(new THREE.Matrix3).getNormalMatrix(R),F=new Float32Array(v);for(n=0;n+2<v.length;n+=3)(h=new THREE.Vector3(v[n],v[n+1],v[n+2])).applyMatrix3(B).normalize(),F[n]=h.x,F[n+1]=h.y,F[n+2]=h.z;i.addAttribute("normal",new THREE.BufferAttribute(F,3))}if(void 0!==E&&0<E.length){n=(n=U(b))<E.length?n:0;var N=new Float32Array(E[n]);i.addAttribute("uv",new THREE.BufferAttribute(N,2)),1<E.length&&(n=0==n?1:0,N=new Float32Array(E[n]),i.addAttribute("uv2",new THREE.BufferAttribute(N,2)))}var M=new Uint32Array(w);i.setIndex(new THREE.BufferAttribute(M,1)),i.groups=b,s=u.length/3;var V,q,I=[],C=[];if(g&&g.skinBones&&g.skinWeights&&g.skinBones.length==g.skinWeights.length)for(c=0;c<s;++c){V=new THREE.Vector4(0,0,0,0),q=new THREE.Vector4(0,0,0,0);var W=0;for(r=0;r<4;++r)r<g.skinBones[c].length?(V.setComponent(r,g.skinBones[c][r]),q.setComponent(r,g.skinWeights[c][r]),++W):(V.setComponent(r,0),q.setComponent(r,0));for(;W<g.skinWeights[c].length;)q.addScalar(.25*g.skinWeights[c][W]),++W;I.push(V),C.push(q)}if(0<I.length&&0<C.length)for(o="SkinnedMesh",i.addAttribute("skinIndex",new THREE.Float32BufferAttribute(new Float32Array(4*l),4)),i.addAttribute("skinWeight",new THREE.Float32BufferAttribute(new Float32Array(4*l),4)),c=0;c<l;++c)V=I[n=m[c]],q=C[n],i.attributes.skinIndex.setXYZW(c,V.x,V.y,V.z,V.w),i.attributes.skinWeight.setXYZW(c,q.x,q.y,q.z,q.w);else o="Mesh";if("SkinnedMesh"==o){var P=K(a);P&&0<P.length&&(i.bones=P)}_.push(i),J.push(o),D.push(a),G.push(y)}}}(),function(){var e=z.animation;if(e&&e.keyframeAnimations&&0!=e.keyframeAnimations.length){var n,t,r,s=e.keyframeAnimations.concat(),i=[];for(t=0;t<s.length;++t)(r=l(s[t]))&&i.push(r);if(0<i.length)for(n=0;n<_.length;++n){var o=!1;if(_[n]instanceof THREE.Geometry?o=_[n].skinIndices&&0<_[n].skinIndices.length&&_[n].skinWeights&&0<_[n].skinWeights.length:_[n]instanceof THREE.BufferGeometry&&(o=_[n].attributes.skinIndex&&0<_[n].attributes.skinIndex.count&&_[n].attributes.skinWeight&&0<_[n].attributes.skinWeight.count),o)_[n].animations=i;else for(_[n].animations=[],t=0;t<s.length;++t)(r=a(s[t],G[n]))&&_[n].animations.push(r)}}}(),e=0;e<_.length;++e)_[e].computeFaceNormals(),_[e].computeBoundingSphere(),n.push({geometry:_[e],type:J[e],jd_object:D[e]});var t=function(){var e,n,t=new THREE.Sphere,r=0,s=0,i=0,o=[],a=[],l=new THREE.Vector3(0,0,0),u=new THREE.Vector3(0,0,0);if(_&&_.length){for(e=0;e<_.length;++e)_[e].boundingSphere||_[e].computeBoundingSphere(),s+=_[e].boundingSphere.radius;if(0<s){for(e=0;e<_.length;++e)n=_[e],a.push(n.boundingSphere.radius),o.push(n.boundingSphere.center),u.copy(n.boundingSphere.center),u.multiplyScalar(n.boundingSphere.radius/s),l.add(u);for(e=0;e<_.length;++e){var c=l.distanceTo(o[e]);r<=c&&(i=(r=c)+a[e])}t.center=l,t.radius=i}}return t}();return{objects:n,materials:y,jd_materials:z.materials,boundingSphere:t}}}]),e}(),s=function(){function e(){r(this,e)}return n(e,[{key:"load",value:function(e,n){var t=this;(new o).load(e,function(e){t.parse(JSON.parse(e),n)})}},{key:"parse",value:function(e,n){var t=e;a.isObject(e)||(t=JSON.parse(e));var r=[];t.animNodes.forEach(function(e){r.push(new THREE.VectorKeyframeTrack(e.nodeName+".position",e.pos.times,e.pos.values)),r.push(new THREE.VectorKeyframeTrack(e.nodeName+".scale",e.scl.times,e.scl.values)),r.push(new THREE.QuaternionKeyframeTrack(e.nodeName+".quaternion",e.rot.times,e.rot.values))});var s=new THREE.AnimationClip(t.name,t.length,r);n&&n(s)}}]),e}(),i=function(){function t(e,n){r(this,t),this.Loader=new o,this.sources=new a.Queue,this.holdLinear=!0,this.isBlock=!1,this.handleSuccess=function(e,n){console.log(n.src+"加载成功")},this.handleFail=function(e,n){console.log(n.src+"加载失败"),console.log(e)},this.AllCompleted=!1,this.handleAllLoaded=function(){console.log("全部加载完成")},this.handleBlock=function(){console.log("加载失败发生队列阻塞")},e&&this.initSources(e),void 0===n||a.isNULL(n)||(this.holdLinear=n)}return n(t,[{key:"initSources",value:function(e,n){var t=this;if(!a.isArray(e))throw new Error('The param "srcArray" must be Array');e.forEach(function(e){console.log(e),t.appendSource(e)}),void 0===n||a.isNULL(n)||(this.holdLinear=n)}},{key:"start",value:function(){this.sources.isEmpty()?console.log("队列为空"):(console.log("开始加载队列..."),this.loadFront())}},{key:"loadFront",value:function(){var n=this,t=this.sources.front();console.log("开始加载"+t.src),this.Loader.load(t.src,function(e){t.handleSuccess?t.handleSuccess(e,t):n.handleSuccess(e,t)},function(e){t.handleFail?t.handleFail(e,t):n.handleFail(e,t),n.holdLinear||(n.isBlock=!0,n.handleBlock&&n.handleBlock(t))},function(e){if(n.sources.dequeue(),n.isBlock)return!1;n.sources.isEmpty()?(n.AllCompleted=!0,n.handleAllLoaded&&n.handleAllLoaded()):n.loadFront()})}},{key:"appendSource",value:function(e){var n={index:this.sources.size()+1};if(a.isString(e))n.src=e;else if(a.isObject(e)){if(!e.src)return console.error('"src" is required'),!1;n.src=e.src,e.success&&(n.handleSuccess=e.success),e.error&&(n.handleFail=e.error)}console.log(n),this.sources.enqueue(n)}},{key:"success",value:function(e){e&&a.isFunction(e)&&(this.handleSuccess=e)}},{key:"error",value:function(e){e&&a.isFunction(e)&&(this.handleFail=e)}},{key:"allLoaded",value:function(e){e&&a.isFunction(e)&&(this.handleAllLoaded=e)}},{key:"block",value:function(e){e&&a.isFunction(e)&&(this.handleBlock=e)}}]),t}();e.FileLoader=o,e.JDLoader=t,e.AnimLoader=s,e.LinearLoader=i,Object.defineProperty(e,"__esModule",{value:!0})});